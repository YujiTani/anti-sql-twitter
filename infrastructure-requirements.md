# インフラ構築要件書

## 概要

本格的なプロダクション環境を想定したDocker Compose構成で、負荷分散・可用性・セキュリティを考慮したアーキテクチャを段階的に構築する。

## 段階的構築計画

### 🚀 Phase 1: 基本構成 (CPU負荷軽減)

```
Internet (HTTP:80) ※開発環境
        ↓
┌─────────────────┐
│     Nginx       │ HTTP通信、リバースプロキシ
│    Port: 80     │
└─────────────────┘
        ↓ HTTP (内部通信)
┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │    Backend      │
│      1台        │    │      1台        │
│   Port: 3001    │    │   Port: 3000    │
└─────────────────┘    └─────────────────┘
                              ↓ PostgreSQL Protocol
                   ┌─────────────────┐
                   │   PostgreSQL    │
                   │    1台 (Master) │
                   │   Port: 5432    │
                   └─────────────────┘
```

### 📊 Phase 1 リソース使用量

- **予想メモリ使用量**: 約2-3GB
- **予想CPU使用率**: 軽負荷（デュアルコアi5で余裕）
- **コンテナ数**: 4個

### 🔧 Phase 2: 負荷分散対応

- Frontend: 1台→3台
- Backend: 1台→3台
- PostgreSQL: Master 1台維持

### 🗄️ Phase 3: データベース分散

- PostgreSQL Read Replica追加（3台）
- Read/Write分散ロジック実装

## Phase 1 詳細仕様

### 1. Nginx (リバースプロキシ)

- **通信**: HTTP (開発環境、後でHTTPS化)
- **ポート**: 80
- **役割**: Frontend/Backend振り分け
- **CPU制限**: 0.1コア
- **メモリ制限**: 64MB

### 2. Frontend (React)

- **インスタンス**: 1台
- **ポート**: 3001
- **通信**: Nginxからの内部HTTP通信
- **CPU制限**: 0.3コア
- **メモリ制限**: 256MB

### 3. Backend (Hono API)

- **インスタンス**: 1台
- **ポート**: 3000
- **通信**: Nginxからの内部HTTP通信
- **CPU制限**: 0.5コア
- **メモリ制限**: 512MB

### 4. PostgreSQL

- **インスタンス**: 1台 (Master)
- **ポート**: 5432
- **通信**: Backendからの直接接続
- **CPU制限**: 1.0コア
- **メモリ制限**: 1GB

## ネットワーク設計 (Phase 1)

### シンプルネットワーク

```yaml
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
```

### IP割り当て

- **Nginx**: 172.20.0.10
- **Frontend**: 172.20.0.11
- **Backend**: 172.20.0.12
- **PostgreSQL**: 172.20.0.13

## Phase 1 の利点

### ✅ 開発効率

- 軽量でレスポンス良好
- ログ確認が簡単
- デバッグしやすい

### ✅ 学習効果

- 基本アーキテクチャの理解
- Docker Composeの習得
- 段階的複雑化で理解しやすい

### ✅ CPU負荷対策

- デュアルコアi5に最適化
- 必要最小限のリソース使用
- 後から段階的にスケールアップ

## 最終構成 (Phase 3完了時)

### アーキテクチャ概要

```
Internet (HTTPS:443)
        ↓
┌─────────────────┐
│     Nginx       │ HTTPS通信、SSL終端
│   Load Balancer │ TCP制限、Port制限
│    Port: 443    │
└─────────────────┘
        ↓ HTTP (内部通信)
┌─────────────────┐    ┌─────────────────┐
│   Frontend      │    │    Backend      │
│     x 3台       │    │      x 3台      │
│  Port: 3001-3   │    │  Port: 3000-2   │
│   IP制限あり     │    │   IP制限あり     │
└─────────────────┘    └─────────────────┘
                              ↓ PostgreSQL Protocol
                   ┌─────────────────┐
                   │   PostgreSQL    │
                   │ Master(Write)x1 │
                   │  Slave(Read)x3  │
                   │ Port: 5432-5435 │
                   │   IP制限あり     │
                   └─────────────────┘
```

### 最終リソース要件

- **メモリ**: 約8-10GB (16GB環境で余裕)
- **CPU**: フル活用（監視しながら調整）
- **コンテナ数**: 10個

## セキュリティ設定

### Phase 1 (基本設定)

- 内部通信のみ（外部は80ポートのみ）
- 基本的なファイアウォール設定
- 環境変数によるシークレット管理

### Phase 2-3 (強化設定)

- HTTPS化 + SSL証明書
- ネットワークセグメント分離
- 詳細なアクセス制限
- PostgreSQL SSL/TLS強制

## 環境変数設定

### ローカル開発環境

```bash
# バックエンドディレクトリで実行
cd backend
cp .env.sample .env.local
```

### 必須環境変数

#### ORIGIN (CORS設定)

```bash
# 開発環境
ORIGIN=http://localhost:3001

# 本番環境  
ORIGIN=https://your-domain.com
```

- **用途**: CORS（Cross-Origin Resource Sharing）設定
- **設定しない場合**: エラーでアプリケーション停止
- **セキュリティ**: 必須設定。具体的なドメインを指定してセキュリティを確保

### オプション環境変数

#### PORT (サーバーポート)

```bash
# デフォルト: 3000
PORT=3000
```

## 次のステップ

Phase 1の構築から始めて、動作確認後に段階的にスケールアップしていきます。

この段階的アプローチで進めてよろしいですか？
